---
import BaseLayout from "@/layouts/BaseLayout.astro";
import GalleryHeader from "@/components/Gallery-LandingHeader.jsx";
import GalleryInfo from "@/components/GalleryInfo.jsx";
import ChapterViewer from "@/components/Chapter-Engrained-Series.jsx";
import Footer from "@/components/Footer.astro";

import { galleryData as allImages } from "@/data/Other/K4-Select-Series/Engrained/Engrained-Series.mjs";
import { landingWestern } from "@/data/Other/K4-Select-Series/Engrained/landingstones.ts";
import { getStructuredData } from "@/components/utils/getStructuredData.ts";

// helper to fix common UTF-8→Latin-1 mojibake
function fixMojibake(str: string) {
  return str
    .replace(/â€™/g, "’")
    .replace(/â€œ/g, "“")
    .replace(/â€�/g, "”")
    .replace(/â€“/g, "–")
    .replace(/â€”/g, "—")
    .replace(/â€¦/g, "…");
}

const { breadcrumb, entranceData = {}, initialImageId } = Astro.props;

const isGhost = !initialImageId || initialImageId === "i-k4studios";
const currentImage = isGhost
  ? null
  : allImages.find(img => img.id === initialImageId && img.visibility !== "ghost");

// pick one random preview image to act as featured
const previewImages = allImages.filter(img => img.visibility !== "ghost").slice(0, 8);
const previewPath = "/Other/K4-Select-Series/Engrained/Engrained-Series";
const singlePreviewImage = previewImages.length
  ? previewImages[Math.floor(Math.random() * previewImages.length)]
  : null;

const usedEntranceData = {
  ...entranceData,
  image: singlePreviewImage
    ? {
        src: singlePreviewImage.src,
        alt: singlePreviewImage.alt || singlePreviewImage.title || entranceData?.image?.alt,
        caption: singlePreviewImage.title || entranceData?.image?.caption,
      }
    : entranceData?.image,
  breadcrumb: entranceData?.breadcrumb || breadcrumb,
};

const imageStructuredData = currentImage
  ? getStructuredData({ type: "image", data: currentImage })
  : getStructuredData({
      type: "gallery",
      data: {
        title: landingWestern.title,
        description: landingWestern.subtitle,
        url: previewPath,
      },
      images: previewImages,
    });

// dynamic title logic
function formatBreadcrumbTitle(bc) {
  if (!bc) return "Gallery";
  return bc.split("|").map(s => s.trim()).join(" – ");
}
const galleryTitle = formatBreadcrumbTitle(usedEntranceData.breadcrumb || breadcrumb);
const pageTitle = currentImage
  ? (currentImage.title
      ? `${currentImage.title} — ${galleryTitle}`
      : `Chapter ${allImages.findIndex(img => img.id === currentImage.id) + 1} — ${galleryTitle}`
    )
  : galleryTitle;

// clean the title for the <title> tag
const cleanPageTitle = fixMojibake(pageTitle);

// Open Graph / Twitter metadata (only for individual image pages)
const siteBase = import.meta.env.SITE || "https://k4studios.com";
const pageUrl = `${siteBase}${Astro.url.pathname}`;
const ogImage = currentImage ? currentImage.src : usedEntranceData.image?.src;
const ogAlt = currentImage
  ? (currentImage.alt || currentImage.title || galleryTitle)
  : (usedEntranceData.image?.alt || galleryTitle);
const ogDescription =
  currentImage?.description ||
  entranceData?.details ||
  landingWestern.subtitle ||
  usedEntranceData.subtitle;
---

{currentImage && (
  <head>
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:title" content={cleanPageTitle} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={ogAlt} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={pageUrl} />
    <meta name="twitter:title" content={cleanPageTitle} />
    <meta name="twitter:description" content={ogDescription} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={ogAlt} />
  </head>
)}

<BaseLayout title={cleanPageTitle} structuredDataJSON={imageStructuredData}>
  <div id="gallery-content" class="flex-grow relative overflow-hidden">
    <!-- Header stays fixed above intro -->
    <div id="header-section" class="section-visible" style="z-index: 10; position: relative;">
      <GalleryHeader client:load breadcrumb={breadcrumb} />
    </div>

    <div class="h-0 md:h-5"></div>

    <!-- Intro -->
    <div id="intro-section" class="section-visible" style="z-index: 1; position: relative;">
      <GalleryInfo client:load entranceData={usedEntranceData} />
    </div>

    <!-- Chapter Viewer Hidden Initially -->
    <div id="chapter-section" class="section-hidden" style="display: none;">
      <ChapterViewer client:load initialImageId={initialImageId || "i-k4studios"} />
    </div>
  </div>

  <!-- Spacer -->
  <div class="h-12 md:h-20"></div>

  <Footer previewImages={previewImages} previewPath={previewPath} />

  <style>
    .hamburger-circle { display: none !important; }
    @media (max-width: 767px) { #nav-toggle { display: none !important; } }
    .section-hidden {
      display: none !important;
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 2s ease, transform 1.2s ease;
      pointer-events: none;
      position: absolute;
      top: 0; left: 0; width: 100%; height: 0; z-index: 0;
    }
    .section-visible {
      opacity: 1;
      transform: translateX(0%);
      transition: opacity 1s ease, transform 1.2s ease;
      pointer-events: auto;
      position: relative; width: 100%; z-index: 2;
    }

    /* override styles – update if layout changes */
    #gallery-content *,
    #gallery-content h1,
    #gallery-content h2,
    #gallery-content h3,
    #gallery-content p,
    #gallery-content a {
      font-family: 'Glegoo', serif !important;
      color: #2c2c2c !important;
      line-height: 1.5 !important;
    }
    #gallery-content h1 {
      font-size: 2.25rem !important;
      font-weight: 700 !important;
      margin-bottom: 0.5em !important;
    }
    #gallery-content h2 {
      font-size: 1.75rem !important;
      font-weight: 600 !important;
      margin-bottom: 0.75em !important;
    }
    #gallery-content p {
      font-size: 1rem !important;
      margin-bottom: 1em !important;
    }
    #gallery-content a {
      text-decoration: underline !important;
      color: #85644b !important;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const exploreButton = document.querySelector('.explore-button');
      const header = document.getElementById('header-section');
      const intro = document.getElementById('intro-section');
      const chapter = document.getElementById('chapter-section');
      const navToggle = document.getElementById('nav-toggle');
      const floatingHeader = document.getElementById('floating-header');
      const menuLabel = document.getElementById('menu-label');
      const topSpacer = document.getElementById('top-spacer');
      let isMenuOpen = false;

      // auto-open on deep-link
      const deepLinkMatch = window.location.pathname.match(/\/(i-[a-zA-Z0-9_-]+)$/);
      if (deepLinkMatch && deepLinkMatch[1] !== "i-k4studios") {
        setTimeout(() => exploreButton?.click(), 50);
      }

      exploreButton?.addEventListener('click', () => {
        header?.classList.add('section-hidden');
        intro?.classList.add('section-hidden');
        chapter.style.display = 'block';
        setTimeout(() => {
          chapter.classList.remove('section-hidden');
          chapter.classList.add('section-visible');
        }, 50);
        if (window.innerWidth >= 768) navToggle?.classList.remove('hidden');
        if (topSpacer) { topSpacer.style.marginTop="0"; topSpacer.style.height="0"; topSpacer.style.overflow="hidden"; }
      });

      navToggle?.addEventListener('click', () => {
        isMenuOpen = !isMenuOpen;
        menuLabel.textContent = isMenuOpen ? "M−" : "M+";
        floatingHeader?.classList.toggle('show');
      });
    });
    document.addEventListener('contextmenu', e => { if (e.target.tagName === 'IMG') e.preventDefault(); });
  </script>
</BaseLayout>
